<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Aula</title>
  <link rel="stylesheet" href="css/aula.css" />
</head>

<body>
  <div class="container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <h2 id="cursoNome"></h2>
      <div id="listaModulos"></div>
    </aside>

    <!-- Conteúdo -->
    <main class="conteudo">
      <h1 id="tituloAula"></h1>
      <div id="conteudoAula"></div>

      <div class="nav-buttons">
        <button id="btnPrev">Aula Anterior</button>
        <button id="btnConcluir">Concluir Aula</button>
        <button id="btnNext">Próxima Aula</button>
      </div>
    </main>
  </div>

  <script type="module">

    // ===== UTIL =====
    function getId(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    const cursoId = getId("curso");
    const aulaId = getId("aula");

    let cursoData = null;      // curso completo
    let aulasLineares = [];    // lista de aulas em ordem

    // ======================================================
    // ===== CARREGAR CURSO COMPLETO (para montar sidebar) ==
    // ======================================================
    async function carregarCurso() {
      const res = await fetch(`/api/curso/${cursoId}`);
      if (!res.ok) return alert("Erro ao carregar curso.");
      const data = await res.json();
      cursoData = data;

      document.getElementById("cursoNome").innerText = data.nome;

      gerarListaLinearAulas();
      montarSidebar();
    }

    // gera uma lista linear única: aula 1, 2, 3, 4...
    function gerarListaLinearAulas() {
      aulasLineares = [];

      cursoData.modulos.forEach((mod) => {
        mod.aulas.forEach((a) => {
          aulasLineares.push({
            ...a,
            moduloId: mod.id,
            moduloNome: mod.nome
          });
        });
      });

      // garante ordem absoluta
      aulasLineares.sort((a, b) => a.ordem_aula - b.ordem_aula);
    }

    // ======================================================
    // ========== CARREGAR AULA ATUAL =======================
    // ======================================================
    async function carregarAula() {
      const res = await fetch(`/api/curso/aula/${aulaId}`);
      if (!res.ok) return alert("Erro ao carregar aula.");
      const aula = await res.json();

      document.getElementById("tituloAula").innerText = aula.titulo;
      document.getElementById("conteudoAula").innerHTML = aula.conteudo;

      configurarBotoesNavegacao();
    }

    // ======================================================
    // ======== SIDE BAR BLOQUEADA (LÓGICA IGUAL CURSO) ======
    // ======================================================
    function montarSidebar() {
      const container = document.getElementById("listaModulos");
      container.innerHTML = "";

      cursoData.modulos.forEach((mod) => {
        const modDiv = document.createElement("div");
        modDiv.classList.add("modulo");

        const titulo = document.createElement("h3");
        titulo.innerText = mod.nome;
        modDiv.appendChild(titulo);

        mod.aulas.forEach((a) => {
          const aulaDiv = document.createElement("div");
          aulaDiv.classList.add("aula-item");

          // bloqueio igual página de curso
          if (!a.liberada) aulaDiv.classList.add("bloqueada");
          if (a.status === "concluida") aulaDiv.classList.add("concluida");

          const idx = aulasLineares.findIndex(x => x.id == a.id);
          aulaDiv.innerHTML = `
            <span class="numero">${idx + 1}</span>
            <span>${a.titulo}</span>
          `;

          if (a.liberada) {
            aulaDiv.style.cursor = "pointer";
            aulaDiv.onclick = () => {
              window.location.href = `/pages/aula.html?curso=${cursoId}&aula=${a.id}`;
            };
          }

          modDiv.appendChild(aulaDiv);
        });

        container.appendChild(modDiv);
      });
    }

    // ======================================================
    // ===== BOTÕES PREV / NEXT  ============================
    // ======================================================
    function configurarBotoesNavegacao() {
      const indexAtual = aulasLineares.findIndex(a => a.id == aulaId);

      const btnPrev = document.getElementById("btnPrev");
      const btnNext = document.getElementById("btnNext");

      // anterior
      if (indexAtual > 0) {
        btnPrev.onclick = () => {
          const prev = aulasLineares[indexAtual - 1];
          window.location.href = `/pages/aula.html?curso=${cursoId}&aula=${prev.id}`;
        };
      } else {
        btnPrev.style.opacity = "0.4";
        btnPrev.style.pointerEvents = "none";
      }

      // próxima
      const proxima = aulasLineares[indexAtual + 1];
      if (proxima && proxima.liberada) {
        btnNext.onclick = () => {
          window.location.href = `/pages/aula.html?curso=${cursoId}&aula=${proxima.id}`;
        };
      } else {
        btnNext.style.opacity = "0.4";
        btnNext.style.pointerEvents = "none";
      }

      // botão concluir
      document.getElementById("btnConcluir").onclick = concluirAulaAtual;
    }

    // ======================================================
    // =============== CONCLUIR AULA ========================
    // ======================================================
    async function concluirAulaAtual() {
      const res = await fetch(`/api/curso/aula/${aulaId}/concluir`, {
        method: "PATCH"
      });

      if (!res.ok) {
        const txt = await res.text();
        return alert("Erro: " + txt);
      }

      // recarrega curso para liberar próxima aula
      await carregarCurso();

      // atualiza prev/next + sidebar
      configurarBotoesNavegacao();
      montarSidebar();

      alert("Aula concluída!");
    }

    // ======================================================
    // =============== INICIALIZAÇÃO =========================
    // ======================================================
    (async () => {
      await carregarCurso();
      await carregarAula();
    })();

  </script>
</body>
</html>
