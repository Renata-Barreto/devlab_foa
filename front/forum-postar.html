<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Criar novo tópico</title>

    <!-- Tagify CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css"
    />

    <!-- Quill Editor -->
    <link
      href="https://cdn.quilljs.com/1.3.6/quill.snow.css"
      rel="stylesheet"
    />

    <!-- Estilos externos -->
    <link rel="stylesheet" href="css/navbar.css" />
    <link rel="stylesheet" href="css/forum-postar.css" />
    <link rel="stylesheet" href="css/profile-dropdown-menu.css" />
  </head>

  <body>
    <nav class="navbar" id="navbar"></nav>

    <div class="layout">
      <aside class="sidebar">
        <h2>Menu</h2>
        <ul>
          <li><a href="forum-substituto.html">Início</a></li>
          <li><a href="#">Tópicos</a></li>
          <li><a href="#">Minhas Postagens</a></li>
          <li><a href="#">Perfil</a></li>
        </ul>
      </aside>

      <main class="main-content">
        <div class="container">
          <h1>Criar novo tópico</h1>

          <div class="form-group">
            <label for="titulo">Título</label>
            <input
              type="text"
              id="titulo"
              placeholder="Digite o título aqui..."
            />
          </div>

          <div class="form-group">
            <label for="descricao">Descrição</label>
            <div id="editor" class="quill-editor"></div>
          </div>

          <div class="form-group">
            <label for="categoria">Categoria</label>
            <select id="categoria" required>
              <option value="" disabled selected>Escolha uma categoria</option>
            </select>
          </div>

          <div class="form-group">
            <label for="tags">Tags <small>(opcional)</small></label>
            <input
              type="text"
              id="tags"
              class="tags-input"
              placeholder="Ex: javascript, html"
            />
          </div>

          <button id="criarTopico" type="button">Criar Tópico</button>
        </div>
      </main>

      <aside class="right-panel">
        <h2>Dicas</h2>
        <p>
          Antes de publicar, verifique se seu título está claro e sua descrição
          é detalhada.
        </p>
        <hr />
        <p>
          Use tags relevantes para que outras pessoas encontrem seu tópico com
          facilidade.
        </p>
      </aside>
    </div>

    <div id="loadingOverlay" style="display: none">
      <div class="spinner"></div>
      Postando...
    </div>

    <!-- Scripts -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script src="js/menu-drop.js" defer></script>
    <script src="js/menu.js"></script>
    <!-- Tagify JS -->
    <script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify"></script>

    <script src="https://cdn.jsdelivr.net/npm/jwt-decode/build/jwt-decode.min.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const auth = JSON.parse(localStorage.getItem("auth"));
        if (!auth || !auth.token) {
          window.location.href = "login.html";
          return;
        }

        let userId;
        try {
          const decoded = jwt_decode(auth.token);
          userId = decoded.id;
          console.log("Usuário autenticado:", decoded);
        } catch (err) {
          console.error("Token inválido:", err);
          localStorage.removeItem("auth");
          window.location.href = "login.html";
          return;
        }

        let tagify;

        async function carregarTags() {
          try {
            const res = await fetch("http://127.0.0.1:3000/api/tags");
            if (!res.ok) throw new Error(`Erro HTTP: ${res.status}`);
            const tags = await res.json();
            console.log("Tags carregadas:", tags);
            const input = document.getElementById("tags");
            tagify = new Tagify(input, {
              whitelist: tags.map((tag) => ({
                value: tag.nome,
                id: tag.id,
              })),
              enforceWhitelist: false,
              dropdown: {
                enabled: 1,
                classname: "tags-look",
                maxItems: 10,
                position: "text",
                closeOnSelect: false,
              },
            });
          } catch (err) {
            console.error("Erro ao carregar tags:", err);
          }
        }

        async function carregarCategorias() {
          const categoriaSelect = document.getElementById("categoria");
          try {
            const res = await fetch("http://127.0.0.1:3000/api/categorias");
            if (!res.ok) throw new Error(`Erro HTTP: ${res.status}`);
            const categorias = await res.json();
            console.log("Categorias carregadas:", categorias);
            categoriaSelect.innerHTML =
              '<option value="" disabled selected>Escolha uma categoria</option>';

            categorias.forEach((cat) => {
              const option = document.createElement("option");
              option.value = cat.id;
              option.textContent = cat.nome;
              categoriaSelect.appendChild(option);
            });
          } catch (err) {
            console.error("Erro ao carregar categorias:", err);
          }
        }

        carregarTags();
        carregarCategorias();

        const quill = new Quill("#editor", {
          theme: "snow",
          placeholder: "Digite sua descrição aqui...",
        });

        const btn = document.getElementById("criarTopico");
        const overlay = document.getElementById("loadingOverlay");

        btn.addEventListener("click", async (event) => {
          event.preventDefault();

          try {
            const titulo = document.getElementById("titulo").value.trim();
            const descricao = quill.root.innerHTML.trim();
            const categoria = document.getElementById("categoria").value;
            const tags = tagify.value.map((t) => parseInt(t.id));

            if (!titulo || !descricao || !categoria) {
              alert("Preencha todos os campos obrigatórios.");
              return;
            }

            overlay.style.display = "flex";

            console.log("Enviando dados para /api/topicos:", {
              titulo,
              descricao,
              categoria_id: parseInt(categoria),
              tags,
              user_id: userId,
            });

            const response = await fetch("http://127.0.0.1:3000/api/topicos", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${auth.token}`,
              },
              body: JSON.stringify({
                titulo,
                descricao,
                categoria_id: parseInt(categoria),
                tags,
                user_id: userId,
              }),
            });

            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(
                `Erro HTTP: ${response.status} - ${
                  errorData.error || response.statusText
                }`
              );
            }

            const resultado = await response.json();
            console.log("Tópico criado:", resultado);

            overlay.innerHTML = `
          <div style="font-size: 3rem; color: #00ff88;"><i class="fa-solid fa-check"></i></div>
          <div style="margin-top: 1rem;">Postado!</div>
        `;

            setTimeout(() => {
              window.location.href = `post.html?id=${resultado.id}`;
            }, 1500);
          } catch (error) {
            console.error("Erro ao criar tópico:", error);
            overlay.innerHTML = `<div>Erro ao criar tópico: ${error.message}</div>`;
            setTimeout(() => (overlay.style.display = "none"), 2000);
          }
        });
      });
    </script>
    <script src="/js/menu-drop.js" defer></script>
  </body>
</html>
