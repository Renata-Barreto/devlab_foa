<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Criar novo tópico</title>

    <!-- Tagify CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css"
    />

    <!-- Quill Editor -->
    <link
      href="https://cdn.quilljs.com/1.3.6/quill.snow.css"
      rel="stylesheet"
    />

    <!-- Estilos externos -->
    <link rel="stylesheet" href="css/navbar.css" />
    <link rel="stylesheet" href="css/forum-postar.css" />
    <link rel="stylesheet" href="css/profile-dropdown-menu.css" />
  </head>

  <body>
    <nav class="navbar" id="navbar"></nav>

    <div class="layout">
      <aside class="sidebar">
        <h2>Menu</h2>
        <ul>
          <li><a href="forum-substituto.html">Início</a></li>
          <li><a href="#">Tópicos</a></li>
          <li><a href="#">Minhas Postagens</a></li>
          <li><a href="#">Perfil</a></li>
        </ul>
      </aside>

      <main class="main-content">
        <div class="container">
          <h1>Criar novo tópico</h1>

          <div class="form-group">
            <label for="titulo">Título</label>
            <input
              type="text"
              id="titulo"
              placeholder="Digite o título aqui..."
            />
          </div>

          <div class="form-group">
            <label for="descricao">Descrição</label>
            <div id="editor" class="quill-editor"></div>
          </div>

          <div class="form-group">
            <label for="categoria">Categoria</label>
            <select id="categoria" required>
              <option value="" disabled selected>Escolha uma categoria</option>
            </select>
          </div>

          <div class="form-group">
            <label for="tags">Tags <small>(opcional)</small></label>
            <input
              type="text"
              id="tags"
              class="tags-input"
              placeholder="Ex: javascript, html"
            />
          </div>

          <button id="criarTopico" type="button">Criar Tópico</button>
        </div>
      </main>

      <aside class="right-panel">
        <h2>Dicas</h2>
        <p>
          Antes de publicar, verifique se seu título está claro e sua descrição
          é detalhada.
        </p>
        <hr />
        <p>
          Use tags relevantes para que outras pessoas encontrem seu tópico com
          facilidade.
        </p>
      </aside>
    </div>

    <div id="loadingOverlay" style="display: none">
      <div class="spinner"></div>
      Postando...
    </div>

    <!-- Scripts -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script src="js/menu-drop.js" defer></script>
    <script src="js/menu.js"></script>
    <!-- Tagify JS -->
    <script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify"></script>

    <script src="https://cdn.jsdelivr.net/npm/jwt-decode/build/jwt-decode.min.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const authRaw = localStorage.getItem("auth");
        let auth, userId;

        try {
          auth = JSON.parse(authRaw);
          if (!auth || !auth.token) throw new Error("Token ausente");
          const decoded = jwt_decode(auth.token);
          userId = decoded.id;
          console.log("Usuário autenticado:", decoded);
        } catch (err) {
          console.error("Erro de autenticação:", err.message);
          localStorage.removeItem("auth");
          window.location.href = "login.html";
          return;
        }

        // Inicializar Quill
        const quill = new Quill("#editor", {
          theme: "snow",
          placeholder: "Digite sua descrição aqui...",
        });

        // Carregar Tags
        let tagify;
        async function carregarTags() {
          try {
            const res = await fetch("https://devlab-foa.onrender.com/api/forum/tags");
            const tags = await res.json();
            tagify = new Tagify(document.getElementById("tags"), {
              whitelist: tags.map((t) => ({ value: t.nome, id: t.id })),
              enforceWhitelist: false,
            });
          } catch (err) {
            console.error("Erro ao carregar tags:", err);
          }
        }

        async function carregarCategorias() {
          const select = document.getElementById("categoria");
          try {
            const res = await fetch("https://devlab-foa.onrender.com/api/forum/categorias");
            const categorias = await res.json();
            select.innerHTML =
              '<option value="" disabled selected>Escolha uma categoria</option>';
            categorias.forEach((cat) => {
              const option = document.createElement("option");
              option.value = cat.id;
              option.textContent = cat.nome;
              select.appendChild(option);
            });
          } catch (err) {
            console.error("Erro ao carregar categorias:", err);
          }
        }

        carregarTags();
        carregarCategorias();

        // Botão Criar Tópico
        const btnCriar = document.getElementById("criarTopico");
        const overlay = document.getElementById("loadingOverlay");

        btnCriar.addEventListener("click", async () => {
          const titulo = document.getElementById("titulo").value.trim();
          const descricao = quill.root.innerHTML.trim();
          const categoriaId = document.getElementById("categoria").value;
          const tags = tagify.value.map((t) => t.value);

          if (!titulo || !descricao || !categoriaId) {
            alert("Preencha todos os campos obrigatórios.");
            return;
          }

          try {
            overlay.style.display = "flex";

            const response = await fetch(
              "https://devlab-foa.onrender.com/api/forum/topicos",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${auth.token}`,
                },
                body: JSON.stringify({
                  titulo,
                  descricao,
                  categoria_id: parseInt(categoriaId),
                  tags,
                  user_id: userId,
                }),
              }
            );

            if (!response.ok) {
              const errorData = await response.json().catch(() => ({}));
              throw new Error(
                `Erro HTTP: ${response.status} - ${
                  errorData.error || response.statusText
                }`
              );
            }

            const newTopic = await response.json();
            console.log("Tópico criado:", newTopic);

            overlay.innerHTML = `<div style="font-size:2rem;color:#00ff88;">✔ Postado!</div>`;

            setTimeout(() => {
              window.location.href = `post.html?id=${newTopic.id}`;
            }, 1500);
          } catch (err) {
            console.error("Erro ao criar tópico:", err.message);
            overlay.innerHTML = `<div>Erro: ${err.message}</div>`;
            setTimeout(() => (overlay.style.display = "none"), 2000);
          }
        });
      });
    </script>
  </body>
</html>
